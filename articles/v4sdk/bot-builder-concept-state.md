---
title: 상태 관리 | Microsoft Docs
description: Bot Framework SDK 내에서 상태가 작동하는 방법을 설명합니다.
keywords: 상태, 봇 상태, 대화 상태, 사용자 상태
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 11/15/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: dfbc9f4ed0f08c7349d758147460b8268c49e372
ms.sourcegitcommit: b15cf37afc4f57d13ca6636d4227433809562f8b
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 01/11/2019
ms.locfileid: "54225868"
---
# <a name="managing-state"></a>상태 관리

봇 내의 상태는 최신 웹 애플리케이션과 동일한 패러다임을 따르며, Bot Framework SDK는 상태 관리를 더 쉽게 하기 위해 몇 가지 추상화를 제공합니다.

웹앱과 마찬가지로, 봇은 기본적으로 상태를 저장하지 않습니다. 봇의 다른 인스턴스에서 대화의 지정된 턴을 처리할 수 있습니다. 일부 봇의 경우 봇이 추가 정보 없이 작동할 수 있거나 필요한 정보가 들어오는 메시지 내에 있도록 보장하는 등 이러한 단순성이 선호됩니다. 다른 사용자의 경우 봇에서 유용한 대화를 하기 위해 상태(예: 대화 중인 위치 또는 이전에 사용자에 대한 데이터가 수신된 위치)가 필요합니다.

**상태가 필요한 이유**

상태를 유지 관리하면 사용자 또는 대화에 대한 특정 항목을 기억함으로써 더 의미 있는 대화를 할 수 있습니다. 예를 들어 이전에 사용자와 대화한 적이 있으면 해당 사용자에 대한 이전 정보를 저장할 수 있으므로 다시 요청할 필요가 없습니다. 또한 상태는 데이터를 현재 턴보다 오래 유지하므로 다중 턴 대화를 수행하는 동안 봇에서 정보를 유지할 수 있습니다.

봇과 관련하여 여기서 다루는 상태의 사용에는 몇 가지 계층, 즉 스토리지 계층, 상태 관리(아래 다이어그램의 봇 상태에 포함) 및 상태 속성 접근자가 있습니다. 이 다이어그램에서는 메서드 호출을 나타내는 실선 화살표 및 반환 값이 있거나 없는 응답을 나타내는 파선 모양 화살표를 사용하여 이러한 계층 간의 상호작용 시퀀스의 일부를 보여 줍니다.

![봇 상태](media/bot-builder-state.png)

이 다이어그램의 흐름과 관련된 각 계층에 대해 다음 섹션에서 자세히 설명하고 있습니다.

## <a name="storage-layer"></a>스토리지 계층

상태 정보가 실제로 저장되는 백 엔드에서 시작하는 *스토리지 계층*입니다. 이는 메모리 내, Azure 또는 타사 서버와 같은 실제 스토리지로 간주할 수 있습니다.

Bot Framework SDK에는 스토리지 계층에 대한 몇 가지 구현이 포함되어 있습니다.

- **메모리 스토리지**는 테스트를 위한 메모리 내 스토리지를 구현합니다. 메모리 내 데이터 스토리지는 휘발성 및 임시 스토리지이므로 로컬 테스트 전용으로만 사용됩니다. 데이터는 봇이 다시 시작될 때마다 지워집니다.
- **Azure Blob Storage**는 Azure Blob Storage 개체 데이터베이스에 연결됩니다.
- **Azure Cosmos DB 스토리지**는 Cosmos DB NoSQL 데이터베이스에 연결됩니다.

다른 스토리지 옵션에 연결하는 방법에 대한 지침은 [스토리지에 직접 작성](bot-builder-howto-v4-storage.md)을 참조하세요.

## <a name="state-management"></a>상태 관리

*상태 관리*는 기본 스토리지 계층에 대한 봇 상태의 읽기 및 쓰기를 자동화합니다. 상태는 봇에서 특정 기본 구현을 고려할 필요 없이 상태 관리 개체를 통해 읽고 쓸 수 있는 효과적인 키-값 쌍인 *상태 속성*으로 저장됩니다. 이러한 상태 속성은 해당 정보가 저장되는 방법을 정의합니다. 예를 들어 특정 클래스 또는 개체로 정의한 속성을 검색할 때 해당 데이터가 구성되는 방식을 알 수 있습니다.

이러한 상태 속성은 범위가 지정된 "버킷"으로 묶이며, 해당 속성을 구성하는 데 도움이 되는 컬렉션일 뿐입니다. SDK에 포함된 세 가지 "버킷"은 다음과 같습니다.

- 사용자 상태
- 대화 상태
- 개인 대화 상태

이러한 모든 버킷은 서로 다른 범위에 속한 다른 유형의 버킷을 정의하기 위해 파생될 수 있는 *봇 상태* 클래스의 하위 클래스입니다.

이처럼 미리 정의된 버킷은 버킷에 따라 특정 가시성에 대한 범위로 지정됩니다.

- 사용자 상태는 대화와 관계없이 봇이 해당 채널에서 해당 사용자와 대화하는 모든 턴에서 사용할 수 있습니다.
- 대화 상태는 사용자(예: 그룹 대화)와 관계없이 특정 대화의 모든 턴에서 사용할 수 있습니다.
- 개인 대화 상태는 특정 대화와 특정 사용자 모두에 대한 범위로 지정됩니다.

> [!TIP]
> 사용자 및 대화 상태는 모두 채널별로 범위가 지정됩니다.
> 서로 다른 채널을 사용하여 봇에 액세스하는 동일한 사용자는 각 채널마다 하나씩 고유한 사용자 상태가 있는 다른 사용자로 나타납니다.

이처럼 미리 정의된 각 버킷에 사용되는 키는 사용자, 대화 또는 둘 다와 관련이 있습니다. 상태 속성에 대한 값을 설정할 때 각 사용자 또는 대화가 올바른 버킷과 속성에 배치되도록 턴 컨텍스트에 포함된 정보를 사용하여 내부적으로 키가 정의됩니다. 특히 키는 다음과 같이 정의됩니다.

- 사용자 상태는 *채널 ID* 및 *원본 ID*를 사용하여 키를 만듭니다. 예: _{Activity.ChannelId}/users/{Activity.From.Id}#YourPropertyName_
- 대화 상태는 *채널 ID* 및 *대화 ID*를 사용하여 키를 만듭니다. 예: _{Activity.ChannelId}/conversations/{Activity.Conversation.Id}#YourPropertyName_
- 개인 대화 상태는 *채널 ID*, *원본 ID* 및 *대화 ID*를 사용하여 키를 만듭니다. 예: _{Activity.ChannelId}/conversations/{Activity.Conversation.Id}/users/{Activity.From.Id}#YourPropertyName_

### <a name="when-to-use-each-type-of-state"></a>각 유형의 상태를 사용하는 경우

대화 상태는 다음과 같은 대화의 컨텍스트를 추적하는 데 적합합니다.

- 봇에서 사용자에게 질문을 했는지 여부, 그리고 어떤 질문이었는지
- 대화의 현재 주제가 무엇인지 또는 마지막 주제는 무엇인지

사용자 상태는 다음과 같은 사용자에 대한 정보를 추적하는 데 적합합니다.

- 중요하지 않은 사용자 정보(예: 이름 및 기본 설정, 경보 설정 또는 경고 기본 설정)
- 봇과의 마지막 대화에 대한 정보
  - 예를 들어 제품 지원 봇에서는 사용자가 질문한 제품을 추적할 수 있습니다.

개인 대화 상태는 그룹 대화를 지원하지만 사용자와 대화 특정 정보를 모두 추적하려는 채널에 적합합니다. 예를 들어 클래스룸 원격 제어 봇이 있는 경우 다음과 같습니다.

- 봇에서 지정된 질문에 대한 학생의 응답을 집계하고 표시할 수 있습니다.
- 봇에서 각 학생의 성적을 집계하고, 세션이 끝날 때 개인적으로 다시 전달할 수 있습니다.

이러한 미리 정의된 버킷을 사용하는 방법에 대한 자세한 내용은 [상태 사용 방법 문서](bot-builder-howto-v4-state.md)를 참조하세요.

### <a name="connecting-to-multiple-databases"></a>여러 데이터베이스에 연결

봇에서 여러 데이터베이스에 연결해야 하는 경우 각 데이터베이스에 대한 스토리지 계층을 만듭니다.
각 스토리지 계층에 대해 상태 속성을 지원하는 데 필요한 상태 관리 개체를 만듭니다.

## <a name="state-property-accessors"></a>상태 속성 접근자

*상태 속성 접근자*는 실제로 상태 속성 중 하나를 읽거나 쓰는 데 사용되며, *get*, *set* 및 *delete* 메서드를 제공하여 단일 턴 내에서 상태 속성에 액세스합니다. 접근자를 만들려면 일반적으로 봇을 초기화할 때 발생하는 속성 이름을 제공해야 합니다. 그런 다음, 해당 접근자를 사용하여 봇의 상태에 대한 속성을 가져오고 조작할 수 있습니다.

접근자를 사용하면 SDK를 통해 기본 스토리지에서 상태를 가져오고 사용자에 대한 봇의 *상태 캐시*를 업데이트할 수 있습니다. 상태 캐시는 사용자에 대한 상태 개체를 저장하는 봇에서 유지 관리되는 로컬 캐시이며, 기본 스토리지에 액세스하지 않고도 읽기 및 쓰기 작업을 허용합니다. 아직 캐시에 없는 경우 접근자의 *get* 메서드를 호출하면 상태를 검색하고 이를 캐시에 배치합니다. 일단 검색되면 상태 속성은 로컬 변수처럼 조작할 수 있습니다.

접근자의 *delete* 메서드는 캐시에서 속성을 제거하고 기본 스토리지에서도 해당 속성을 삭제합니다.

> [!IMPORTANT]
> 접근자의 *get* 메서드에 대한 첫 번째 호출의 경우 상태에 개체가 아직 없으면 해당 개체를 만드는 팩터리 메서드를 제공해야 합니다. 팩터리 메서드가 지정되지 않으면 예외가 발생합니다. 팩터리 메서드를 사용하는 방법에 대한 자세한 내용은 [상태 사용 방법 문서](bot-builder-howto-v4-state.md)에서 확인할 수 있습니다.

접근자에서 가져온 상태 속성에 대한 변경 내용을 유지하려면 상태 캐시의 속성을 업데이트해야 합니다. 이렇게 하려면 속성 값을 캐시에 설정하고 나중에 이를 읽거나 업데이트해야 하는 경우 사용할 수 있는 *set* 메서드 호출을 통해 수행할 수 있습니다. 실제로 해당 데이터를 기본 스토리지에 유지하려면(이에 따라 현재 턴 이후에 사용할 수 있도록 설정) [상태를 저장](#saving-state)해야 합니다.

### <a name="how-the-state-property-accessor-methods-work"></a>상태 속성 접근자 메서드의 작동 방식

접근자 메서드는 봇에서 상태와 상호 작용하는 기본 방법입니다. 각각의 작동 방식과 기본 계층에서 상호 작용하는 방식은 다음과 같습니다.

- 접근자의 *get* 메서드:
  - 접근자가 상태 캐시에서 속성을 요청합니다.
  - 속성이 캐시에 있으면 이를 반환합니다. 그렇지 않으면 상태 관리 개체에서 가져옵니다.
    (아직 상태에 없으면 접근자의 *get* 호출에 제공된 팩터리 메서드를 사용합니다.) - 접근자의 *set* 메서드:
  - 상태 캐시를 새 속성 값으로 업데이트합니다.
- 상태 관리 개체의 *변경 내용 저장* 메서드:
  - 상태 캐시에서 속성에 대한 변경 내용을 확인합니다.
  - 해당 속성을 스토리지에 씁니다.

## <a name="saving-state"></a>상태 저장

접근자의 set 메서드를 호출하여 업데이트된 상태를 기록하면 해당 상태 속성이 지속형 스토리지에 아직 저장되지 않고 봇의 상태 캐시에만 대신 저장됩니다. 변경 내용을 지속됨 상태로 상태 캐시에 저장하려면, 위에서 언급한 봇 상태 클래스의 구현(예: 사용자 상태 또는 대화 상태)에서 사용할 수 있는 상태 관리 개체의 *변경 내용 저장* 메서드를 호출해야 합니다.

상태 관리 개체(예: 위에서 언급한 버킷)에 대한 변경 내용 저장 메서드를 호출하면, 해당 버킷의 해당 지점에 설정한 모든 속성이 상태 캐시에 저장되지만 다른 버킷의 속성은 저장되지 않습니다.

> [!TIP]
> 봇 상태는 마지막 쓰기가 이전에 쓴 상태를 덮어쓰는 "마지막으로 성공한 쓰기" 동작을 구현합니다. 이 동작은 많은 애플리케이션에서 제대로 작동할 수 있지만, 특히 진행 중인 일정 수준의 동시성 또는 대기 시간이 있을 수 있는 규모 확장 시나리오에 영향을 줍니다.

턴 처리기가 완료된 후에 상태를 업데이트할 수 있는 일부 사용자 지정 미들웨어가 있는 경우 [미들웨어의 처리 상태](bot-builder-concept-middleware.md#handling-state-in-middleware)를 고려하세요.

## <a name="additional-resources"></a>추가 리소스

- [대화 상태](bot-builder-concept-dialog.md#dialog-state)
- [저장소에 직접 작성](bot-builder-howto-v4-storage.md)
- [대화 및 사용자 데이터 저장](bot-builder-howto-v4-state.md)